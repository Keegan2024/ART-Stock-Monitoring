<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Stock Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .auth-container {
            max-width: 400px;
            margin: 5rem auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .dashboard {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .report-form {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .commodities-table {
            margin-top: 2rem;
        }

        .auto-calc {
            background: #e9ecef !important;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .text-center {
            text-align: center;
        }

        .mt-3 {
            margin-top: 1rem;
        }

        .action-btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin: 0 0.25rem;
        }

        .back-btn {
            margin-bottom: 1rem;
        }

        .facility-structure {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .table {
                font-size: 0.9rem;
            }

            .facility-structure {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="authSection">
        <div class="auth-container">
            <div class="text-center">
                <h1 class="logo">Medical Stock Management System</h1>
                <p style="color: #6c757d; margin-bottom: 2rem;">District Health Facilities Stock Management</p>
            </div>

            <div id="loginForm">
                <h2 style="margin-bottom: 1.5rem; text-align: center;">Sign In</h2>
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" class="form-control" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
                </form>
                <div class="text-center mt-3">
                    <button onclick="showSignup()" class="btn btn-secondary">Create New Account</button>
                </div>
            </div>

            <div id="signupForm" class="hidden">
                <h2 style="margin-bottom: 1.5rem; text-align: center;">Sign Up</h2>
                <form onsubmit="signup(event)">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" class="form-control" id="signupName" required>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" class="form-control" id="signupUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" id="signupPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select class="form-control" id="signupRole" required>
                            <option value="">Select Role</option>
                            <option value="facility">Health Facility User</option>
                            <option value="coordinator">District Coordinator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" class="form-control" id="signupPhone" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
                </form>
                <div class="text-center mt-3">
                    <button onclick="showLogin()" class="btn btn-secondary">Back to Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mainSystem" class="hidden">
        <div class="container">
            <div class="header">
                <div class="logo">Medical Stock Management System</div>
                <div class="user-info">
                    <span id="currentUser"></span>
                    <button onclick="logout()" class="btn btn-danger">Logout</button>
                </div>
            </div>

            <div class="dashboard">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
                    <button class="nav-tab" onclick="showTab('reports')">Submit Report</button>
                    <button class="nav-tab" onclick="showTab('review')">Review Reports</button>
                    <button class="nav-tab" onclick="showTab('manage')" id="manageTab" style="display: none;">Manage System</button>
                </div>

                <div id="dashboardTab" class="tab-content active">
                    <h2>Dashboard Overview</h2>
                    <div class="grid">
                        <div class="card">
                            <h3>Total Reports Submitted</h3>
                            <h1 id="totalReports" style="color: #667eea;">0</h1>
                        </div>
                        <div class="card">
                            <h3>Pending Reviews</h3>
                            <h1 id="pendingReports" style="color: #ffc107;">0</h1>
                        </div>
                        <div class="card">
                            <h3>Approved Reports</h3>
                            <h1 id="approvedReports" style="color: #28a745;">0</h1>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Recent Activity</h3>
                        <div id="recentActivity">
                            <p>No recent activity</p>
                        </div>
                    </div>
                </div>

                <div id="reportsTab" class="tab-content">
                    <button onclick="showTab('dashboard')" class="btn btn-secondary back-btn">← Back to Dashboard</button>
                    <h2>Submit Stock Report</h2>
                    <div class="report-form">
                        <div class="grid">
                            <div class="form-group">
                                <label>Reporting Period</label>
                                <select class="form-control" id="reportPeriod" required>
                                    <option value="">Select Period</option>
                                    <option value="week">Weekly</option>
                                    <option value="month">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Year</label>
                                <select class="form-control" id="reportYear" required></select>
                            </div>
                            <div class="form-group">
                                <label>Week/Month</label>
                                <select class="form-control" id="reportWeekMonth" required></select>
                            </div>
                            <div class="form-group">
                                <label>Reporter Name</label>
                                <input type="text" class="form-control" id="reporterName" required>
                            </div>
                        </div>
                        
                        <div class="facility-structure">
                            <div class="form-group">
                                <label>Province</label>
                                <select class="form-control" id="reportProvince" required onchange="updateDistricts()">
                                    <option value="">Select Province</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>District</label>
                                <select class="form-control" id="reportDistrict" required onchange="updateHubs()">
                                    <option value="">Select District</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Hub</label>
                                <select class="form-control" id="reportHub" required onchange="updateFacilities()">
                                    <option value="">Select Hub</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Facility</label>
                            <select class="form-control" id="reportFacility" required>
                                <option value="">Select Facility</option>
                            </select>
                        </div>
                        
                        <button onclick="loadCommodities()" class="btn btn-primary">Load Commodities</button>
                    </div>

                    <div id="commoditiesSection" class="hidden">
                        <h3>Stock Report Template</h3>
                        <div class="commodities-table">
                            <table class="table" id="commoditiesTable">
                                <thead>
                                    <tr>
                                        <th>Commodity</th>
                                        <th>Description</th>
                                        <th>Expiry Date</th>
                                        <th>Opening Balance</th>
                                        <th>Received</th>
                                        <th>Used</th>
                                        <th>Given to Other Facility</th>
                                        <th>Facility Name (if given)</th>
                                        <th>Closing Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="commoditiesBody"></tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <button onclick="addCommodityRow()" class="btn btn-info">Add Another Commodity</button>
                            <button onclick="submitReport()" class="btn btn-success">Submit Report for Review</button>
                        </div>
                    </div>
                </div>

                <div id="reviewTab" class="tab-content">
                    <button onclick="showTab('dashboard')" class="btn btn-secondary back-btn">← Back to Dashboard</button>
                    <h2>Review Reports</h2>
                    <div class="card">
                        <table class="table" id="reviewTable">
                            <thead>
                                <tr>
                                    <th>Report ID</th>
                                    <th>Facility</th>
                                    <th>Reporter</th>
                                    <th>Period</th>
                                    <th>Date Submitted</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reviewBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="manageTab" class="tab-content">
                    <button onclick="showTab('dashboard')" class="btn btn-secondary back-btn">← Back to Dashboard</button>
                    <h2>System Management</h2>
                    
                    <div class="card">
                        <h3>User Management</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Username</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>

                    <div class="grid">
                        <div class="card">
                            <h3>Add New Facility</h3>
                            <div class="facility-structure">
                                <div class="form-group">
                                    <label>Province</label>
                                    <input type="text" class="form-control" id="newFacilityProvince" placeholder="Province" required>
                                </div>
                                <div class="form-group">
                                    <label>District</label>
                                    <input type="text" class="form-control" id="newFacilityDistrict" placeholder="District" required>
                                </div>
                                <div class="form-group">
                                    <label>Hub</label>
                                    <input type="text" class="form-control" id="newFacilityHub" placeholder="Hub" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="newFacilityName" placeholder="Facility Name" required>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="newFacilityLocation" placeholder="Location Details" required>
                            </div>
                            <button onclick="addFacility()" class="btn btn-primary">Add Facility</button>
                        </div>

                        <div class="card">
                            <h3>Add New Commodity</h3>
                            <div class="form-group">
                                <input type="text" class="form-control" id="newCommodityName" placeholder="Commodity Name" required>
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="newCommodityCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="essential_drugs">Essential Drugs</option>
                                    <option value="hiv_testing">HIV Testing Kits</option>
                                    <option value="arvs">ARVs</option>
                                    <option value="other_medical">Other Medical Items</option>
                                    <option value="non_medical">Non-Medical Items</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="newCommodityDescription" placeholder="Description" required>
                            </div>
                            <button onclick="addCommodity()" class="btn btn-primary">Add Commodity</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Report Details</h2>
            <div id="reportDetails"></div>
            <div class="text-center mt-3">
                <button onclick="approveReport()" class="btn btn-success">Approve</button>
                <button onclick="rejectReport()" class="btn btn-danger">Reject</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('msms_users') || '[]';
        let facilities = JSON.parse(localStorage.getItem('msms_facilities') || '[]';
        let commodities = JSON.parse(localStorage.getItem('msms_commodities') || '[]';
        let reports = JSON.parse(localStorage.getItem('msms_reports') || '[]';
        let currentReport = null;
        let provinces = [];
        let districts = [];
        let hubs = [];

        // Initialize default data
        function initializeDefaultData() {
            // Convert string to array if it's stored as string
            if (typeof users === 'string') users = JSON.parse(users);
            if (typeof facilities === 'string') facilities = JSON.parse(facilities);
            if (typeof commodities === 'string') commodities = JSON.parse(commodities);
            if (typeof reports === 'string') reports = JSON.parse(reports);

            if (facilities.length === 0) {
                facilities = [
                    { 
                        id: 1, 
                        name: 'Central District Hospital', 
                        province: 'Lusaka', 
                        district: 'Lusaka', 
                        hub: 'Central Hub', 
                        location: 'Central District' 
                    },
                    { 
                        id: 2, 
                        name: 'North Health Center', 
                        province: 'Copperbelt', 
                        district: 'Kitwe', 
                        hub: 'Northern Hub', 
                        location: 'North District' 
                    },
                    { 
                        id: 3, 
                        name: 'South Clinic', 
                        province: 'Southern', 
                        district: 'Livingstone', 
                        hub: 'Southern Hub', 
                        location: 'South District' 
                    }
                ];
                localStorage.setItem('msms_facilities', JSON.stringify(facilities));
            }

            if (commodities.length === 0) {
                commodities = [
                    { id: 1, name: 'ARV Combination Tablets', category: 'arvs', description: 'Antiretroviral medication' },
                    { id: 2, name: 'HIV Rapid Test Kit', category: 'hiv_testing', description: 'Quick HIV testing kit' },
                    { id: 3, name: 'Paracetamol 500mg', category: 'essential_drugs', description: 'Pain relief medication' },
                    { id: 4, name: 'Medical Gloves', category: 'other_medical', description: 'Disposable examination gloves' },
                    { id: 5, name: 'Office Supplies', category: 'non_medical', description: 'General office materials' }
                ];
                localStorage.setItem('msms_commodities', JSON.stringify(commodities));
            }

            // Create default admin user
            if (users.length === 0) {
                users.push({
                    id: 1,
                    name: 'System Admin',
                    username: 'admin',
                    email: 'admin@health.gov',
                    password: 'admin123',
                    role: 'coordinator',
                    status: 'approved',
                    phone: '+260-xxx-xxx-xxx'
                });
                localStorage.setItem('msms_users', JSON.stringify(users));
            }

            // Initialize facility structure data
            updateFacilityStructureData();
        }

        // Update facility structure data (provinces, districts, hubs)
        function updateFacilityStructureData() {
            provinces = [...new Set(facilities.map(f => f.province))];
            districts = [...new Set(facilities.map(f => f.district))];
            hubs = [...new Set(facilities.map(f => f.hub))];
        }

        // Authentication Functions
        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function login(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                if (user.status === 'approved') {
                    currentUser = user;
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('mainSystem').classList.remove('hidden');
                    document.getElementById('currentUser').textContent = user.name;
                    
                    if (user.role === 'coordinator') {
                        document.getElementById('manageTab').style.display = 'block';
                    }
                    
                    loadDashboard();
                    populateDropdowns();
                } else {
                    alert('Your account is pending approval. Please contact the administrator.');
                }
            } else {
                alert('Invalid username or password');
            }
        }

        function signup(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;
            const phone = document.getElementById('signupPhone').value;

            if (users.find(u => u.username === username)) {
                alert('Username already exists');
                return;
            }

            if (users.find(u => u.email === email)) {
                alert('Email already exists');
                return;
            }

            const newUser = {
                id: Date.now(),
                name,
                username,
                email,
                password,
                role,
                phone,
                status: 'pending'
            };

            users.push(newUser);
            localStorage.setItem('msms_users', JSON.stringify(users));
            
            alert('Account created successfully! Please wait for admin approval.');
            showLogin();
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('manageTab').style.display = 'none';
            
            // Reset forms
            document.getElementById('loginForm').reset?.();
            document.getElementById('signupForm').reset?.();
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`.nav-tab[onclick="showTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'review') {
                loadReviewReports();
            } else if (tabName === 'manage') {
                loadUserManagement();
            } else if (tabName === 'reports') {
                // Reset report form when showing reports tab
                document.getElementById('commoditiesSection').classList.add('hidden');
            }
        }

        // Dashboard Functions
        function loadDashboard() {
            const userReports = reports.filter(r => 
                currentUser.role === 'coordinator' || r.reporter_email === currentUser.email
            );
            
            document.getElementById('totalReports').textContent = userReports.length;
            document.getElementById('pendingReports').textContent = userReports.filter(r => r.status === 'pending').length;
            document.getElementById('approvedReports').textContent = userReports.filter(r => r.status === 'approved').length;
            
            // Load recent activity
            const recentReports = userReports.slice(-5).reverse();
            const activityHtml = recentReports.length > 0 
                ? recentReports.map(r => `<p>${r.facility_name} - ${r.period} ${r.year} (${r.status})</p>`).join('')
                : '<p>No recent activity</p>';
            document.getElementById('recentActivity').innerHTML = activityHtml;
        }

        function populateDropdowns() {
            // Populate year dropdown
            const yearSelect = document.getElementById('reportYear');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            }
            yearSelect.value = currentYear;

            // Populate provinces dropdown
            const provinceSelect = document.getElementById('reportProvince');
            provinceSelect.innerHTML = '<option value="">Select Province</option>';
            provinces.forEach(province => {
                provinceSelect.innerHTML += `<option value="${province}">${province}</option>`;
            });

            // Populate districts dropdown (initially empty)
            const districtSelect = document.getElementById('reportDistrict');
            districtSelect.innerHTML = '<option value="">Select District</option>';

            // Populate hubs dropdown (initially empty)
            const hubSelect = document.getElementById('reportHub');
            hubSelect.innerHTML = '<option value="">Select Hub</option>';

            // Populate facilities dropdown (initially empty)
            const facilitySelect = document.getElementById('reportFacility');
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';

            // Set reporter name to current user's name
            if (currentUser) {
                document.getElementById('reporterName').value = currentUser.name;
            }

            // Set up period change handler
            document.getElementById('reportPeriod').addEventListener('change', updatePeriodOptions);
        }

        function updatePeriodOptions() {
            const period = document.getElementById('reportPeriod').value;
            const weekMonthSelect = document.getElementById('reportWeekMonth');
            
            weekMonthSelect.innerHTML = '<option value="">Select</option>';
            
            if (period === 'week') {
                for (let i = 1; i <= 52; i++) {
                    weekMonthSelect.innerHTML += `<option value="week-${i}">Week ${i}</option>`;
                }
            } else if (period === 'month') {
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
                months.forEach((month, index) => {
                    weekMonthSelect.innerHTML += `<option value="month-${index + 1}">${month}</option>`;
                });
            }
        }

        // Facility structure functions
        function updateDistricts() {
            const province = document.getElementById('reportProvince').value;
            const districtSelect = document.getElementById('reportDistrict');
            
            districtSelect.innerHTML = '<option value="">Select District</option>';
            
            if (province) {
                const provinceDistricts = [...new Set(facilities
                    .filter(f => f.province === province)
                    .map(f => f.district))];
                
                provinceDistricts.forEach(district => {
                    districtSelect.innerHTML += `<option value="${district}">${district}</option>`;
                });
            }
            
            // Reset hubs and facilities
            document.getElementById('reportHub').innerHTML = '<option value="">Select Hub</option>';
            document.getElementById('reportFacility').innerHTML = '<option value="">Select Facility</option>';
        }

        function updateHubs() {
            const province = document.getElementById('reportProvince').value;
            const district = document.getElementById('reportDistrict').value;
            const hubSelect = document.getElementById('reportHub');
            
            hubSelect.innerHTML = '<option value="">Select Hub</option>';
            
            if (province && district) {
                const districtHubs = [...new Set(facilities
                    .filter(f => f.province === province && f.district === district)
                    .map(f => f.hub))];
                
                districtHubs.forEach(hub => {
                    hubSelect.innerHTML += `<option value="${hub}">${hub}</option>`;
                });
            }
            
            // Reset facilities
            document.getElementById('reportFacility').innerHTML = '<option value="">Select Facility</option>';
        }

        function updateFacilities() {
            const province = document.getElementById('reportProvince').value;
            const district = document.getElementById('reportDistrict').value;
            const hub = document.getElementById('reportHub').value;
            const facilitySelect = document.getElementById('reportFacility');
            
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            
            if (province && district && hub) {
                const hubFacilities = facilities
                    .filter(f => f.province === province && f.district === district && f.hub === hub);
                
                hubFacilities.forEach(facility => {
                    facilitySelect.innerHTML += `<option value="${facility.id}">${facility.name}</option>`;
                });
            }
        }

        // Report Functions
        function loadCommodities() {
            const period = document.getElementById('reportPeriod').value;
            const year = document.getElementById('reportYear').value;
            const weekMonth = document.getElementById('reportWeekMonth').value;
            const reporterName = document.getElementById('reporterName').value;
            const facilityId = document.getElementById('reportFacility').value;

            if (!period || !year || !weekMonth || !reporterName || !facilityId) {
                alert('Please fill in all report details first');
                return;
            }

            const facility = facilities.find(f => f.id == facilityId);
            if (!facility) {
                alert('Invalid facility selected');
                return;
            }

            // Show commodities section
            document.getElementById('commoditiesSection').classList.remove('hidden');
            
            // Populate commodities table with at least one empty row
            populateCommoditiesTable();
        }

        function populateCommoditiesTable() {
            const tbody = document.getElementById('commoditiesBody');
            tbody.innerHTML = '';
            
            // Add one empty row by default
            addCommodityRow();
        }

        function addCommodityRow() {
            const tbody = document.getElementById('commoditiesBody');
            const rowId = Date.now();
            
            const row = document.createElement('tr');
            row.id = `commodity-row-${rowId}`;
            row.innerHTML = `
                <td>
                    <select class="form-control" id="commodity_${rowId}" onchange="updateCommodityDescription(${rowId})" required>
                        <option value="">Select Commodity</option>
                        ${commodities.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                    </select>
                </td>
                <td><input type="text" class="form-control" id="description_${rowId}" readonly></td>
                <td><input type="date" class="form-control" id="expiry_${rowId}" required></td>
                <td><input type="number" class="form-control" id="opening_${rowId}" min="0" onchange="calculateBalance(${rowId})" required></td>
                <td><input type="number" class="form-control" id="received_${rowId}" min="0" onchange="calculateBalance(${rowId})" required></td>
                <td><input type="number" class="form-control" id="used_${rowId}" min="0" onchange="calculateBalance(${rowId})" required></td>
                <td><input type="number" class="form-control" id="given_${rowId}" min="0" onchange="calculateBalance(${rowId})" required></td>
                <td><input type="text" class="form-control" id="given_facility_${rowId}" placeholder="Facility name if given"></td>
                <td><input type="number" class="form-control auto-calc" id="closing_${rowId}" readonly></td>
                <td>
                    <button onclick="removeCommodityRow(${rowId})" class="btn btn-danger action-btn">Delete</button>
                </td>
            `;
            tbody.appendChild(row);
        }

        function updateCommodityDescription(rowId) {
            const commodityId = document.getElementById(`commodity_${rowId}`).value;
            const commodity = commodities.find(c => c.id == commodityId);
            if (commodity) {
                document.getElementById(`description_${rowId}`).value = commodity.description;
            } else {
                document.getElementById(`description_${rowId}`).value = '';
            }
        }

        function removeCommodityRow(rowId) {
            if (document.querySelectorAll('#commoditiesBody tr').length <= 1) {
                alert('You must have at least one commodity in the report');
                return;
            }
            
            document.getElementById(`commodity-row-${rowId}`).remove();
        }

        function calculateBalance(rowId) {
            const opening = parseInt(document.getElementById(`opening_${rowId}`).value) || 0;
            const received = parseInt(document.getElementById(`received_${rowId}`).value) || 0;
            const used = parseInt(document.getElementById(`used_${rowId}`).value) || 0;
            const given = parseInt(document.getElementById(`given_${rowId}`).value) || 0;
            
            const closing = opening + received - used - given;
            document.getElementById(`closing_${rowId}`).value = Math.max(0, closing);
        }

        function submitReport() {
            const period = document.getElementById('reportPeriod').value;
            const year = document.getElementById('reportYear').value;
            const weekMonth = document.getElementById('reportWeekMonth').value;
            const reporterName = document.getElementById('reporterName').value;
            const facilityId = document.getElementById('reportFacility').value;

            if (!period || !year || !weekMonth || !reporterName || !facilityId) {
                alert('Please fill in all report details first');
                return;
            }

            const facility = facilities.find(f => f.id == facilityId);
            if (!facility) {
                alert('Invalid facility selected');
                return;
            }

            // Collect commodity data from all rows
            const commodityData = [];
            const rows = document.querySelectorAll('#commoditiesBody tr');
            
            for (let i = 0; i < rows.length; i++) {
                const rowId = rows[i].id.split('-')[2];
                const commodityId = document.getElementById(`commodity_${rowId}`).value;
                const commodity = commodities.find(c => c.id == commodityId);
                
                if (!commodity) {
                    alert(`Please select a valid commodity for row ${i + 1}`);
                    return;
                }
                
                const expiry = document.getElementById(`expiry_${rowId}`).value;
                const opening = document.getElementById(`opening_${rowId}`).value;
                const received = document.getElementById(`received_${rowId}`).value;
                const used = document.getElementById(`used_${rowId}`).value;
                const given = document.getElementById(`given_${rowId}`).value;
                const givenFacility = document.getElementById(`given_facility_${rowId}`).value;
                const closing = document.getElementById(`closing_${rowId}`).value;

                if (!expiry || !opening || !received || !used || !given) {
                    alert(`Please fill in all fields for row ${i + 1}`);
                    return;
                }

                commodityData.push({
                    commodity_id: commodity.id,
                    commodity_name: commodity.name,
                    expiry_date: expiry,
                    opening_balance: parseInt(opening),
                    received: parseInt(received),
                    used: parseInt(used),
                    given_to_other: parseInt(given),
                    given_facility_name: givenFacility,
                    closing_balance: parseInt(closing)
                });
            }

            if (commodityData.length === 0) {
                alert('Please add at least one commodity to the report');
                return;
            }

            const newReport = {
                id: Date.now(),
                facility_id: facilityId,
                facility_name: facility.name,
                reporter_name: reporterName,
                reporter_email: currentUser.email,
                period: period,
                week_month: weekMonth,
                year: year,
                commodities: commodityData,
                status: 'pending',
                date_submitted: new Date().toISOString(),
                reviewed_by: null,
                review_date: null,
                province: facility.province,
                district: facility.district,
                hub: facility.hub
            };

            reports.push(newReport);
            localStorage.setItem('msms_reports', JSON.stringify(reports));

            alert('Report submitted successfully for review!');
            
            // Reset form
            document.getElementById('commoditiesSection').classList.add('hidden');
            document.querySelectorAll('#reportsTab input, #reportsTab select').forEach(input => {
                if (input.type !== 'submit' && input.id !== 'reporterName') input.value = '';
            });
            
            loadDashboard();
        }

        // Review Functions
        function loadReviewReports() {
            const tbody = document.getElementById('reviewBody');
            tbody.innerHTML = '';

            const reportsToShow = currentUser.role === 'coordinator' 
                ? reports 
                : reports.filter(r => r.reporter_email === currentUser.email);

            reportsToShow.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>RPT-${report.id}</td>
                    <td>${report.facility_name}</td>
                    <td>${report.reporter_name}</td>
                    <td>${report.period} ${report.week_month} ${report.year}</td>
                    <td>${new Date(report.date_submitted).toLocaleDateString()}</td>
                    <td><span class="status-badge status-${report.status}">${report.status.toUpperCase()}</span></td>
                    <td>
                        <button onclick="viewReport(${report.id})" class="btn btn-primary action-btn">View</button>
                        ${currentUser.role === 'coordinator' && report.status === 'pending' ? 
                            `<button onclick="reviewReport(${report.id})" class="btn btn-secondary action-btn">Review</button>` : ''}
                        ${report.status !== 'approved' ? 
                            `<button onclick="deleteReport(${report.id})" class="btn btn-danger action-btn">Delete</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteReport(reportId) {
            if (confirm('Are you sure you want to delete this report?')) {
                reports = reports.filter(r => r.id !== reportId);
                localStorage.setItem('msms_reports', JSON.stringify(reports));
                loadReviewReports();
                loadDashboard();
                alert('Report deleted successfully!');
            }
        }

        function viewReport(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;

            let detailsHtml = `
                <h3>Report: RPT-${report.id}</h3>
                <p><strong>Facility:</strong> ${report.facility_name}</p>
                <p><strong>Location:</strong> ${report.province} > ${report.district} > ${report.hub}</p>
                <p><strong>Reporter:</strong> ${report.reporter_name}</p>
                <p><strong>Period:</strong> ${report.period} ${report.week_month} ${report.year}</p>
                <p><strong>Status:</strong> <span class="status-badge status-${report.status}">${report.status.toUpperCase()}</span></p>
                <p><strong>Submitted:</strong> ${new Date(report.date_submitted).toLocaleDateString()}</p>
                
                ${report.reviewed_by ? `<p><strong>Reviewed by:</strong> ${report.reviewed_by}</p>` : ''}
                ${report.review_date ? `<p><strong>Review date:</strong> ${new Date(report.review_date).toLocaleDateString()}</p>` : ''}
                ${report.rejection_reason ? `<p><strong>Rejection reason:</strong> ${report.rejection_reason}</p>` : ''}
                
                <h4>Commodities Report:</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Commodity</th>
                            <th>Expiry Date</th>
                            <th>Opening</th>
                            <th>Received</th>
                            <th>Used</th>
                            <th>Given</th>
                            <th>Given to Facility</th>
                            <th>Closing</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            report.commodities.forEach(comm => {
                detailsHtml += `
                    <tr>
                        <td>${comm.commodity_name}</td>
                        <td>${comm.expiry_date}</td>
                        <td>${comm.opening_balance}</td>
                        <td>${comm.received}</td>
                        <td>${comm.used}</td>
                        <td>${comm.given_to_other}</td>
                        <td>${comm.given_facility_name || 'N/A'}</td>
                        <td>${comm.closing_balance}</td>
                    </tr>
                `;
            });

            detailsHtml += '</tbody></table>';

            document.getElementById('reportDetails').innerHTML = detailsHtml;
            document.getElementById('reportModal').style.display = 'block';
            currentReport = report;
        }

        function reviewReport(reportId) {
            viewReport(reportId);
        }

        function approveReport() {
            if (!currentReport || currentUser.role !== 'coordinator') return;

            const reportIndex = reports.findIndex(r => r.id === currentReport.id);
            if (reportIndex !== -1) {
                reports[reportIndex].status = 'approved';
                reports[reportIndex].reviewed_by = currentUser.name;
                reports[reportIndex].review_date = new Date().toISOString();
                localStorage.setItem('msms_reports', JSON.stringify(reports));
                
                alert('Report approved successfully!');
                closeModal();
                loadReviewReports();
                loadDashboard();
            }
        }

        function rejectReport() {
            if (!currentReport || currentUser.role !== 'coordinator') return;

            const reason = prompt('Please provide a reason for rejection:');
            if (!reason) return;

            const reportIndex = reports.findIndex(r => r.id === currentReport.id);
            if (reportIndex !== -1) {
                reports[reportIndex].status = 'rejected';
                reports[reportIndex].reviewed_by = currentUser.name;
                reports[reportIndex].review_date = new Date().toISOString();
                reports[reportIndex].rejection_reason = reason;
                localStorage.setItem('msms_reports', JSON.stringify(reports));
                
                alert('Report rejected successfully!');
                closeModal();
                loadReviewReports();
                loadDashboard();
            }
        }

        function closeModal() {
            document.getElementById('reportModal').style.display = 'none';
            currentReport = null;
        }

        // Management Functions
        function loadUserManagement() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td><span class="status-badge status-${user.status}">${user.status.toUpperCase()}</span></td>
                    <td>
                        ${user.status === 'pending' ? 
                            `<button onclick="approveUser(${user.id})" class="btn btn-success action-btn">Approve</button>
                             <button onclick="rejectUser(${user.id})" class="btn btn-danger action-btn">Reject</button>` : ''}
                        ${user.id !== currentUser.id ? 
                            `<button onclick="deleteUser(${user.id})" class="btn btn-danger action-btn">Delete</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function approveUser(userId) {
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                users[userIndex].status = 'approved';
                localStorage.setItem('msms_users', JSON.stringify(users));
                loadUserManagement();
                alert('User approved successfully!');
            }
        }

        function rejectUser(userId) {
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                users[userIndex].status = 'rejected';
                localStorage.setItem('msms_users', JSON.stringify(users));
                loadUserManagement();
                alert('User rejected successfully!');
            }
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== userId);
                localStorage.setItem('msms_users', JSON.stringify(users));
                loadUserManagement();
                alert('User deleted successfully!');
            }
        }

        function addFacility() {
            const province = document.getElementById('newFacilityProvince').value;
            const district = document.getElementById('newFacilityDistrict').value;
            const hub = document.getElementById('newFacilityHub').value;
            const name = document.getElementById('newFacilityName').value;
            const location = document.getElementById('newFacilityLocation').value;

            if (!province || !district || !hub || !name || !location) {
                alert('Please fill in all facility details');
                return;
            }

            const newFacility = {
                id: Date.now(),
                name,
                province,
                district,
                hub,
                location
            };

            facilities.push(newFacility);
            localStorage.setItem('msms_facilities', JSON.stringify(facilities));
            
            // Update facility structure data
            updateFacilityStructureData();
            
            // Clear form
            document.getElementById('newFacilityProvince').value = '';
            document.getElementById('newFacilityDistrict').value = '';
            document.getElementById('newFacilityHub').value = '';
            document.getElementById('newFacilityName').value = '';
            document.getElementById('newFacilityLocation').value = '';
            
            alert('Facility added successfully!');
        }

        function addCommodity() {
            const name = document.getElementById('newCommodityName').value;
            const category = document.getElementById('newCommodityCategory').value;
            const description = document.getElementById('newCommodityDescription').value;

            if (!name || !category || !description) {
                alert('Please fill in all commodity details');
                return;
            }

            const newCommodity = {
                id: Date.now(),
                name,
                category,
                description
            };

            commodities.push(newCommodity);
            localStorage.setItem('msms_commodities', JSON.stringify(commodities));
            
            document.getElementById('newCommodityName').value = '';
            document.getElementById('newCommodityCategory').value = '';
            document.getElementById('newCommodityDescription').value = '';
            
            alert('Commodity added successfully!');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDefaultData();
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('reportModal');
                if (event.target === modal) {
                    closeModal();
                }
            };
        });
    </script>
</body>
</html>