        function populateDropdowns() {
            // Populate year dropdown
            const yearSelect = document.getElementById('reportYear');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            }
            yearSelect.value = currentYear;

            // Populate provinces
            const provinceSelects = ['reportProvince', 'newFacilityProvince', 'hubProvince', 'districtProvince'];
            provinceSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Province</option>';
                    provinces.forEach(province => {
                        select.innerHTML += `<option value="${province.id}">${province.name}</option>`;
                    });
                }
            });

            // Set up period change handler
            document.getElementById('reportPeriod').addEventListener('change', updatePeriodOptions);
        }

        // Location hierarchy functions
        function loadHubs() {
            const provinceId = document.getElementById('reportProvince').value;
            const hubSelect = document.getElementById('reportHub');
            const districtSelect = document.getElementById('reportDistrict');
            const facilitySelect = document.getElementById('reportFacility');
            
            // Reset dependent dropdowns
            hubSelect.innerHTML = '<option value="">Select Hub</option>';
            districtSelect.innerHTML = '<option value="">Select District</option>';
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            
            if (provinceId) {
                const provinceHubs = hubs.filter(h => h.province_id == provinceId);
                provinceHubs.forEach(hub => {
                    hubSelect.innerHTML += `<option value="${hub.id}">${hub.name}</option>`;
                });
            }
        }

        function loadDistricts() {
            const hubId = document.getElementById('reportHub').value;
            const districtSelect = document.getElementById('reportDistrict');
            const facilitySelect = document.getElementById('reportFacility');
            
            // Reset dependent dropdowns
            districtSelect.innerHTML = '<option value="">Select District</option>';
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            
            if (hubId) {
                const hubDistricts = districts.filter(d => d.hub_id == hubId);
                hubDistricts.forEach(district => {
                    districtSelect.innerHTML += `<option value="${district.id}">${district.name}</option>`;
                });
            }
        }

        function loadFacilitiesByLocation() {
            const districtId = document.getElementById('reportDistrict').value;
            const facilitySelect = document.getElementById('reportFacility');
            
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            
            if (districtId) {
                const districtFacilities = facilities.filter(f => f.district_id == districtId);
                districtFacilities.forEach(facility => {
                    facilitySelect.innerHTML += `<option value="${facility.id}">${facility.name} (${facility.type})</option>`;
                });
            }
        }

        // Management hierarchy functions
        function loadManageHubs() {
            const provinceId = document.getElementById('newFacilityProvince').value;
            const hubSelect = document.getElementById('newFacilityHub');
            const districtSelect = document.getElementById('newFacilityDistrict');
            
            hubSelect.innerHTML = '<option value="">Select Hub</option>';
            districtSelect.innerHTML = '<option value="">Select District</option>';
            
            if (provinceId) {
                const provinceHubs = hubs.filter(h => h.province_id == provinceId);
                provinceHubs.forEach(hub => {
                    hubSelect.innerHTML += `<option value="${hub.id}">${hub.name}</option>`;
                <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Stock Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 1rem 2rem;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #667eea;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .auth-container {
            max-width: 400px;
            margin: 5rem auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #555;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
        }

        .dashboard {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e9ecef;
        }

        .nav-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .table th,
        .table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .table tr:hover {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 15px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .close {
            float: right;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .report-form {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .commodities-table {
            margin-top: 2rem;
        }

        .auto-calc {
            background: #e9ecef !important;
            cursor: not-allowed;
        }

        .hidden {
            display: none;
        }

        .back-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .back-btn:hover {
            background: #5a6268;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .redo-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.25rem 0.5rem;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 0.5rem;
        }

        .redo-btn:hover {
            background: #138496;
        }

        .facility-hierarchy {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .deleted-row {
            background: #f8d7da !important;
            opacity: 0.6;
        }

        .deleted-row input {
            background: #f8d7da !important;
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .text-center {
            text-align: center;
        }

        .mt-3 {
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }
            
            .grid {
                grid-template-columns: 1fr;
            }
            
            .table {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <div id="authSection">
        <div class="auth-container">
            <div class="text-center">
                <h1 class="logo">Medical Stock Management System</h1>
                <p style="color: #6c757d; margin-bottom: 2rem;">District Health Facilities Stock Management</p>
            </div>

            <div id="loginForm">
                <h2 style="margin-bottom: 1.5rem; text-align: center;">Sign In</h2>
                <form onsubmit="login(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" class="form-control" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign In</button>
                </form>
                <div class="text-center mt-3">
                    <button onclick="showSignup()" class="btn btn-secondary">Create New Account</button>
                </div>
            </div>

            <div id="signupForm" class="hidden">
                <h2 style="margin-bottom: 1.5rem; text-align: center;">Sign Up</h2>
                <form onsubmit="signup(event)">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" class="form-control" id="signupName" required>
                    </div>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" class="form-control" id="signupUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" class="form-control" id="signupEmail" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" class="form-control" id="signupPassword" required>
                    </div>
                    <div class="form-group">
                        <label>Role</label>
                        <select class="form-control" id="signupRole" required>
                            <option value="">Select Role</option>
                            <option value="facility">Health Facility User</option>
                            <option value="coordinator">District Coordinator</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone Number</label>
                        <input type="tel" class="form-control" id="signupPhone" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Sign Up</button>
                </form>
                <div class="text-center mt-3">
                    <button onclick="showLogin()" class="btn btn-secondary">Back to Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <div id="mainSystem" class="hidden">
        <div class="container">
            <div class="header">
                <div class="logo">Medical Stock Management System</div>
                <div class="user-info">
                    <span id="currentUser"></span>
                    <button onclick="logout()" class="btn btn-danger">Logout</button>
                </div>
            </div>

            <div class="dashboard">
                <div class="nav-tabs">
                    <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
                    <button class="nav-tab" onclick="showTab('reports')">Submit Report</button>
                    <button class="nav-tab" onclick="showTab('review')">Review Reports</button>
                    <button class="nav-tab" onclick="showTab('manage')" id="manageTab" style="display: none;">Manage System</button>
                </div>

                <div id="dashboardTab" class="tab-content active">
                    <h2>Dashboard Overview</h2>
                    <div class="grid">
                        <div class="card">
                            <h3>Total Reports Submitted</h3>
                            <h1 id="totalReports" style="color: #667eea;">0</h1>
                        </div>
                        <div class="card">
                            <h3>Pending Reviews</h3>
                            <h1 id="pendingReports" style="color: #ffc107;">0</h1>
                        </div>
                        <div class="card">
                            <h3>Approved Reports</h3>
                            <h1 id="approvedReports" style="color: #28a745;">0</h1>
                        </div>
                    </div>

                    <div class="card">
                        <h3>Recent Activity</h3>
                        <div id="recentActivity">
                            <p>No recent activity</p>
                        </div>
                    </div>
                </div>

                <div id="reportsTab" class="tab-content">
                    <button class="back-btn" onclick="goBackToReportsList()" id="backToReports" style="display: none;">
                        ‚Üê Back to Reports List
                    </button>
                    
                    <h2>Submit Stock Report</h2>
                    <div class="report-form">
                        <div class="facility-hierarchy">
                            <div class="form-group">
                                <label>Province</label>
                                <select class="form-control" id="reportProvince" onchange="loadHubs()" required>
                                    <option value="">Select Province</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Hub</label>
                                <select class="form-control" id="reportHub" onchange="loadDistricts()" required>
                                    <option value="">Select Hub</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>District</label>
                                <select class="form-control" id="reportDistrict" onchange="loadFacilitiesByLocation()" required>
                                    <option value="">Select District</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid">
                            <div class="form-group">
                                <label>Reporting Period</label>
                                <select class="form-control" id="reportPeriod" required>
                                    <option value="">Select Period</option>
                                    <option value="week">Weekly</option>
                                    <option value="month">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Year</label>
                                <select class="form-control" id="reportYear" required></select>
                            </div>
                            <div class="form-group">
                                <label>Week/Month</label>
                                <select class="form-control" id="reportWeekMonth" required></select>
                            </div>
                            <div class="form-group">
                                <label>Reporter Name</label>
                                <input type="text" class="form-control" id="reporterName" required>
                            </div>
                            <div class="form-group">
                                <label>Facility</label>
                                <select class="form-control" id="reportFacility" required>
                                    <option value="">Select Facility</option>
                                </select>
                            </div>
                        </div>
                        <button onclick="loadCommodities()" class="btn btn-primary">Load Commodities</button>
                        <button onclick="saveDraft()" class="btn btn-secondary" style="margin-left: 1rem;">Save Draft</button>
                        <button onclick="loadDraft()" class="btn btn-secondary" style="margin-left: 0.5rem;">Load Draft</button>
                    </div>

                    <div id="commoditiesSection" class="hidden">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Stock Report Template</h3>
                            <button onclick="clearAllEntries()" class="btn btn-danger">Clear All Entries</button>
                        </div>
                        <div class="commodities-table">
                            <table class="table" id="commoditiesTable">
                                <thead>
                                    <tr>
                                        <th>Commodity</th>
                                        <th>Description</th>
                                        <th>Expiry Date</th>
                                        <th>Opening Balance</th>
                                        <th>Received</th>
                                        <th>Used</th>
                                        <th>Given to Other Facility</th>
                                        <th>Facility Name (if given)</th>
                                        <th>Closing Balance</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="commoditiesBody"></tbody>
                            </table>
                        </div>
                        <div class="text-center mt-3">
                            <button onclick="submitReport()" class="btn btn-success">Submit Report for Review</button>
                            <button onclick="cancelReport()" class="btn btn-secondary" style="margin-left: 1rem;">Cancel Report</button>
                        </div>
                    </div>
                </div>

                <div id="reviewTab" class="tab-content">
                    <h2>Review Reports</h2>
                    <div class="card">
                        <table class="table" id="reviewTable">
                            <thead>
                                <tr>
                                    <th>Report ID</th>
                                    <th>Facility</th>
                                    <th>Reporter</th>
                                    <th>Period</th>
                                    <th>Date Submitted</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reviewBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="manageTab" class="tab-content">
                    <h2>System Management</h2>
                    
                    <div class="card">
                        <h3>User Management</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable"></tbody>
                        </table>
                    </div>

                    <div class="grid">
                        <div class="card">
                            <h3>Add New Facility</h3>
                            <div class="form-group">
                                <input type="text" class="form-control" id="newFacilityName" placeholder="Facility Name">
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="newFacilityLocation" placeholder="Location">
                            </div>
                            <button onclick="addFacility()" class="btn btn-primary">Add Facility</button>
                        </div>

                        <div class="card">
                            <h3>Add New Commodity</h3>
                            <div class="form-group">
                                <input type="text" class="form-control" id="newCommodityName" placeholder="Commodity Name">
                            </div>
                            <div class="form-group">
                                <select class="form-control" id="newCommodityCategory">
                                    <option value="">Select Category</option>
                                    <option value="essential_drugs">Essential Drugs</option>
                                    <option value="hiv_testing">HIV Testing Kits</option>
                                    <option value="arvs">ARVs</option>
                                    <option value="other_medical">Other Medical Items</option>
                                    <option value="non_medical">Non-Medical Items</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <input type="text" class="form-control" id="newCommodityDescription" placeholder="Description">
                            </div>
                            <button onclick="addCommodity()" class="btn btn-primary">Add Commodity</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Report Details Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Report Details</h2>
            <div id="reportDetails"></div>
            <div class="text-center mt-3">
                <button onclick="approveReport()" class="btn btn-success">Approve</button>
                <button onclick="rejectReport()" class="btn btn-danger">Reject</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentUser = null;
        let users = JSON.parse(localStorage.getItem('msms_users') || '[]');
        let facilities = JSON.parse(localStorage.getItem('msms_facilities') || '[]');
        let commodities = JSON.parse(localStorage.getItem('msms_commodities') || '[]');
        let reports = JSON.parse(localStorage.getItem('msms_reports') || '[]');
        let provinces = JSON.parse(localStorage.getItem('msms_provinces') || '[]');
        let hubs = JSON.parse(localStorage.getItem('msms_hubs') || '[]');
        let districts = JSON.parse(localStorage.getItem('msms_districts') || '[]');
        let currentReport = null;
        let deletedRows = new Set();
        let reportDraft = JSON.parse(localStorage.getItem('msms_draft') || 'null');

        // Initialize default data
        function initializeDefaultData() {
            // Initialize provinces
            if (provinces.length === 0) {
                provinces = [
                    { id: 1, name: 'Central Province' },
                    { id: 2, name: 'Copperbelt Province' },
                    { id: 3, name: 'Eastern Province' },
                    { id: 4, name: 'Luapula Province' },
                    { id: 5, name: 'Lusaka Province' }
                ];
                localStorage.setItem('msms_provinces', JSON.stringify(provinces));
            }

            // Initialize hubs
            if (hubs.length === 0) {
                hubs = [
                    { id: 1, name: 'Central Hub', province_id: 1 },
                    { id: 2, name: 'Copperbelt Hub', province_id: 2 },
                    { id: 3, name: 'Eastern Hub', province_id: 3 },
                    { id: 4, name: 'Northern Hub', province_id: 4 },
                    { id: 5, name: 'Lusaka Hub', province_id: 5 }
                ];
                localStorage.setItem('msms_hubs', JSON.stringify(hubs));
            }

            // Initialize districts
            if (districts.length === 0) {
                districts = [
                    { id: 1, name: 'Central District', province_id: 1, hub_id: 1 },
                    { id: 2, name: 'Ndola District', province_id: 2, hub_id: 2 },
                    { id: 3, name: 'Kitwe District', province_id: 2, hub_id: 2 },
                    { id: 4, name: 'Chipata District', province_id: 3, hub_id: 3 },
                    { id: 5, name: 'Mansa District', province_id: 4, hub_id: 4 },
                    { id: 6, name: 'Lusaka District', province_id: 5, hub_id: 5 }
                ];
                localStorage.setItem('msms_districts', JSON.stringify(districts));
            }

            if (facilities.length === 0) {
                facilities = [
                    { id: 1, name: 'Central District Hospital', province_id: 1, hub_id: 1, district_id: 1, type: 'hospital' },
                    { id: 2, name: 'Ndola Teaching Hospital', province_id: 2, hub_id: 2, district_id: 2, type: 'hospital' },
                    { id: 3, name: 'Kitwe Central Hospital', province_id: 2, hub_id: 2, district_id: 3, type: 'hospital' },
                    { id: 4, name: 'Chipata General Hospital', province_id: 3, hub_id: 3, district_id: 4, type: 'hospital' },
                    { id: 5, name: 'Mansa Health Center', province_id: 4, hub_id: 4, district_id: 5, type: 'health_center' },
                    { id: 6, name: 'University Teaching Hospital', province_id: 5, hub_id: 5, district_id: 6, type: 'hospital' }
                ];
                localStorage.setItem('msms_facilities', JSON.stringify(facilities));
            }

            if (commodities.length === 0) {
                commodities = [
                    { id: 1, name: 'ARV Combination Tablets', category: 'arvs', description: 'Antiretroviral medication', unit: 'tablets' },
                    { id: 2, name: 'HIV Rapid Test Kit', category: 'hiv_testing', description: 'Quick HIV testing kit', unit: 'kits' },
                    { id: 3, name: 'Paracetamol 500mg', category: 'essential_drugs', description: 'Pain relief medication', unit: 'tablets' },
                    { id: 4, name: 'Medical Gloves', category: 'other_medical', description: 'Disposable examination gloves', unit: 'pairs' },
                    { id: 5, name: 'Office Supplies', category: 'non_medical', description: 'General office materials', unit: 'items' }
                ];
                localStorage.setItem('msms_commodities', JSON.stringify(commodities));
            }

            // Create default admin user
            if (users.length === 0) {
                users.push({
                    id: 1,
                    name: 'System Admin',
                    username: 'admin',
                    email: 'admin@health.gov',
                    password: 'admin123',
                    role: 'coordinator',
                    status: 'approved',
                    phone: '+260-xxx-xxx-xxx'
                });
                localStorage.setItem('msms_users', JSON.stringify(users));
            }
        }

        // Authentication Functions
        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        function login(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                if (user.status === 'approved') {
                    currentUser = user;
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('mainSystem').classList.remove('hidden');
                    document.getElementById('currentUser').textContent = user.name;
                    
                    if (user.role === 'coordinator') {
                        document.getElementById('manageTab').style.display = 'block';
                    }
                    
                    loadDashboard();
                    populateDropdowns();
                } else {
                    alert('Your account is pending approval. Please contact the administrator.');
                }
            } else {
                alert('Invalid username or password');
            }
        }

        function signup(event) {
            event.preventDefault();
            const name = document.getElementById('signupName').value;
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const role = document.getElementById('signupRole').value;
            const phone = document.getElementById('signupPhone').value;

            if (users.find(u => u.username === username)) {
                alert('Username already exists');
                return;
            }

            if (users.find(u => u.email === email)) {
                alert('Email already exists');
                return;
            }

            const newUser = {
                id: Date.now(),
                name,
                username,
                email,
                password,
                role,
                phone,
                status: 'pending'
            };

            users.push(newUser);
            localStorage.setItem('msms_users', JSON.stringify(users));
            
            alert('Account created successfully! Please wait for admin approval.');
            showLogin();
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainSystem').classList.add('hidden');
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('manageTab').style.display = 'none';
            
            // Reset forms
            document.getElementById('loginForm').querySelectorAll('input').forEach(input => input.value = '');
            document.getElementById('signupForm').querySelectorAll('input, select').forEach(input => input.value = '');
        }

        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'review') {
                loadReviewReports();
            } else if (tabName === 'manage') {
                loadUserManagement();
                loadManagementTab();
            }
        }

        // Dashboard Functions
        function loadDashboard() {
            const userReports = reports.filter(r => 
                currentUser.role === 'coordinator' || r.reporter_email === currentUser.email
            );
            
            document.getElementById('totalReports').textContent = userReports.length;
            document.getElementById('pendingReports').textContent = userReports.filter(r => r.status === 'pending').length;
            document.getElementById('approvedReports').textContent = userReports.filter(r => r.status === 'approved').length;
            
            // Load recent activity
            const recentReports = userReports.slice(-5).reverse();
            const activityHtml = recentReports.length > 0 
                ? recentReports.map(r => `<p>${r.facility_name} - ${r.period} ${r.year} (${r.status})</p>`).join('')
                : '<p>No recent activity</p>';
            document.getElementById('recentActivity').innerHTML = activityHtml;
        }

        function populateDropdowns() {
            // Populate year dropdown
            const yearSelect = document.getElementById('reportYear');
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            }
            yearSelect.value = currentYear;

            // Populate provinces
            const provinceSelects = ['reportProvince', 'newFacilityProvince', 'hubProvince', 'districtProvince'];
            provinceSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (select) {
                    select.innerHTML = '<option value="">Select Province</option>';
                    provinces.forEach(province => {
                        select.innerHTML += `<option value="${province.id}">${province.name}</option>`;
                    });
                }
            });

            // Set up period change handler
            document.getElementById('reportPeriod').addEventListener('change', updatePeriodOptions);
        }

        // Location hierarchy functions
        function loadHubs() {
            const provinceId = document.getElementById('reportProvince').value;
            const hubSelect = document.getElementById('reportHub');
            const districtSelect = document.getElementById('reportDistrict');
            const facilitySelect = document.getElementById('reportFacility');
            
            // Reset dependent dropdowns
            hubSelect.innerHTML = '<option value="">Select Hub</option>';
            districtSelect.innerHTML = '<option value="">Select District</option>';
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            
            if (provinceId) {
                const provinceHubs = hubs.filter(h => h.province_id == provinceId);
                provinceHubs.forEach(hub => {
                    hubSelect.innerHTML += `<option value="${hub.id}">${hub.name}</option>`;
                });
            }
        }

        function loadDistricts() {
            const hubId = document.getElementById('reportHub').value;
            const districtSelect = document.getElementById('reportDistrict');
            const facilitySelect = document.getElementById('reportFacility');
            
            // Reset dependent dropdowns
            districtSelect.innerHTML = '<option value="">Select District</option>';
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            
            if (hubId) {
                const hubDistricts = districts.filter(d => d.hub_id == hubId);
                hubDistricts.forEach(district => {
                    districtSelect.innerHTML += `<option value="${district.id}">${district.name}</option>`;
                });
            }
        }

        function loadFacilitiesByLocation() {
            const districtId = document.getElementById('reportDistrict').value;
            const facilitySelect = document.getElementById('reportFacility');
            
            facilitySelect.innerHTML = '<option value="">Select Facility</option>';
            
            if (districtId) {
                const districtFacilities = facilities.filter(f => f.district_id == districtId);
                districtFacilities.forEach(facility => {
                    facilitySelect.innerHTML += `<option value="${facility.id}">${facility.name} (${facility.type})</option>`;
                });
            }
        }

        // Management hierarchy functions
        function loadManageHubs() {
            const provinceId = document.getElementById('newFacilityProvince').value;
            const hubSelect = document.getElementById('newFacilityHub');
            const districtSelect = document.getElementById('newFacilityDistrict');
            
            hubSelect.innerHTML = '<option value="">Select Hub</option>';
            districtSelect.innerHTML = '<option value="">Select District</option>';
            
            if (provinceId) {
                const provinceHubs = hubs.filter(h => h.province_id == provinceId);
                provinceHubs.forEach(hub => {
                    hubSelect.innerHTML += `<option value="${hub.id}">${hub.name}</option>`;
                });
            }
        }

        function loadManageDistricts() {
            const hubId = document.getElementById('newFacilityHub').value;
            const districtSelect = document.getElementById('newFacilityDistrict');
            
            districtSelect.innerHTML = '<option value="">Select District</option>';
            
            if (hubId) {
                const hubDistricts = districts.filter(d => d.hub_id == hubId);
                hubDistricts.forEach(district => {
                    districtSelect.innerHTML += `<option value="${district.id}">${district.name}</option>`;
                });
            }
        }

        function loadDistrictHubs() {
            const provinceId = document.getElementById('districtProvince').value;
            const hubSelect = document.getElementById('districtHub');
            
            hubSelect.innerHTML = '<option value="">Select Hub</option>';
            
            if (provinceId) {
                const provinceHubs = hubs.filter(h => h.province_id == provinceId);
                provinceHubs.forEach(hub => {
                    hubSelect.innerHTML += `<option value="${hub.id}">${hub.name}</option>`;
                });
            }
        }

        // Back button functionality
        function goBackToReportsList() {
            document.getElementById('commoditiesSection').classList.add('hidden');
            document.getElementById('backToReports').style.display = 'none';
            deletedRows.clear();
        }

        // Draft functionality
        function saveDraft() {
            if (document.getElementById('commoditiesSection').classList.contains('hidden')) {
                alert('Please load commodities first');
                return;
            }

            const draftData = {
                province: document.getElementById('reportProvince').value,
                hub: document.getElementById('reportHub').value,
                district: document.getElementById('reportDistrict').value,
                period: document.getElementById('reportPeriod').value,
                year: document.getElementById('reportYear').value,
                weekMonth: document.getElementById('reportWeekMonth').value,
                reporterName: document.getElementById('reporterName').value,
                facility: document.getElementById('reportFacility').value,
                commodities: []
            };

            commodities.forEach((commodity, index) => {
                if (!deletedRows.has(index)) {
                    draftData.commodities.push({
                        index: index,
                        expiry: document.getElementById(`expiry_${index}`)?.value || '',
                        opening: document.getElementById(`opening_${index}`)?.value || '',
                        received: document.getElementById(`received_${index}`)?.value || '',
                        used: document.getElementById(`used_${index}`)?.value || '',
                        given: document.getElementById(`given_${index}`)?.value || '',
                        givenFacility: document.getElementById(`given_facility_${index}`)?.value || ''
                    });
                }
            });

            localStorage.setItem('msms_draft', JSON.stringify(draftData));
            alert('Draft saved successfully!');
        }

        function loadDraft() {
            if (!reportDraft) {
                alert('No draft found');
                return;
            }

            // Load basic form data
            document.getElementById('reportProvince').value = reportDraft.province;
            loadHubs();
            setTimeout(() => {
                document.getElementById('reportHub').value = reportDraft.hub;
                loadDistricts();
                setTimeout(() => {
                    document.getElementById('reportDistrict').value = reportDraft.district;
                    loadFacilitiesByLocation();
                    setTimeout(() => {
                        document.getElementById('reportFacility').value = reportDraft.facility;
                    }, 100);
                }, 100);
            }, 100);

            document.getElementById('reportPeriod').value = reportDraft.period;
            updatePeriodOptions();
            document.getElementById('reportYear').value = reportDraft.year;
            document.getElementById('reportWeekMonth').value = reportDraft.weekMonth;
            document.getElementById('reporterName').value = reportDraft.reporterName;

            // Load commodities and populate with draft data
            setTimeout(() => {
                loadCommodities();
                setTimeout(() => {
                    reportDraft.commodities.forEach(comm => {
                        if (document.getElementById(`expiry_${comm.index}`)) {
                            document.getElementById(`expiry_${comm.index}`).value = comm.expiry;
                            document.getElementById(`opening_${comm.index}`).value = comm.opening;
                            document.getElementById(`received_${comm.index}`).value = comm.received;
                            document.getElementById(`used_${comm.index}`).value = comm.used;
                            document.getElementById(`given_${comm.index}`).value = comm.given;
                            document.getElementById(`given_facility_${comm.index}`).value = comm.givenFacility;
                            calculateBalance(comm.index);
                        }
                    });
                }, 500);
            }, 200);

            alert('Draft loaded successfully!');
        }

        function clearDraft() {
            localStorage.removeItem('msms_draft');
            reportDraft = null;
        }

        function updatePeriodOptions() {
            const period = document.getElementById('reportPeriod').value;
            const weekMonthSelect = document.getElementById('reportWeekMonth');
            
            weekMonthSelect.innerHTML = '<option value="">Select</option>';
            
            if (period === 'week') {
                for (let i = 1; i <= 52; i++) {
                    weekMonthSelect.innerHTML += `<option value="week-${i}">Week ${i}</option>`;
                }
            } else if (period === 'month') {
                const months = ['January', 'February', 'March', 'April', 'May', 'June',
                              'July', 'August', 'September', 'October', 'November', 'December'];
                months.forEach((month, index) => {
                    weekMonthSelect.innerHTML += `<option value="month-${index + 1}">${month}</option>`;
                });
            }
        }

        // Report Functions
        function loadCommodities() {
            const province = document.getElementById('reportProvince').value;
            const hub = document.getElementById('reportHub').value;
            const district = document.getElementById('reportDistrict').value;
            const period = document.getElementById('reportPeriod').value;
            const year = document.getElementById('reportYear').value;
            const weekMonth = document.getElementById('reportWeekMonth').value;
            const reporterName = document.getElementById('reporterName').value;
            const facilityId = document.getElementById('reportFacility').value;

            if (!province || !hub || !district || !period || !year || !weekMonth || !reporterName || !facilityId) {
                alert('Please fill in all report details first');
                return;
            }

            const facility = facilities.find(f => f.id == facilityId);
            if (!facility) {
                alert('Invalid facility selected');
                return;
            }

            // Show commodities section and back button
            document.getElementById('commoditiesSection').classList.remove('hidden');
            document.getElementById('backToReports').style.display = 'block';
            
            // Reset deleted rows
            deletedRows.clear();
            
            // Populate commodities table
            const tbody = document.getElementById('commoditiesBody');
            tbody.innerHTML = '';
            
            commodities.forEach((commodity, index) => {
                const row = document.createElement('tr');
                row.id = `row_${index}`;
                row.innerHTML = `
                    <td>${commodity.name}</td>
                    <td>${commodity.description}</td>
                    <td><input type="date" class="form-control" id="expiry_${index}" required></td>
                    <td><input type="number" class="form-control" id="opening_${index}" min="0" onchange="calculateBalance(${index})" required></td>
                    <td><input type="number" class="form-control" id="received_${index}" min="0" onchange="calculateBalance(${index})" required></td>
                    <td><input type="number" class="form-control" id="used_${index}" min="0" onchange="calculateBalance(${index})" required></td>
                    <td><input type="number" class="form-control" id="given_${index}" min="0" onchange="calculateBalance(${index})" required></td>
                    <td><input type="text" class="form-control" id="given_facility_${index}" placeholder="Facility name if given"></td>
                    <td><input type="number" class="form-control auto-calc" id="closing_${index}" readonly></td>
                    <td>
                        <button class="delete-btn" onclick="deleteRow(${index})" id="delete_${index}">Delete</button>
                        <button class="redo-btn hidden" onclick="redoRow(${index})" id="redo_${index}">Redo</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function deleteRow(index) {
            const row = document.getElementById(`row_${index}`);
            const deleteBtn = document.getElementById(`delete_${index}`);
            const redoBtn = document.getElementById(`redo_${index}`);
            
            row.classList.add('deleted-row');
            deleteBtn.classList.add('hidden');
            redoBtn.classList.remove('hidden');
            deletedRows.add(index);
            
            // Clear the inputs
            ['expiry', 'opening', 'received', 'used', 'given', 'given_facility', 'closing'].forEach(field => {
                const input = document.getElementById(`${field}_${index}`);
                if (input) {
                    input.value = '';
                    input.disabled = true;
                }
            });
        }

        function redoRow(index) {
            const row = document.getElementById(`row_${index}`);
            const deleteBtn = document.getElementById(`delete_${index}`);
            const redoBtn = document.getElementById(`redo_${index}`);
            
            row.classList.remove('deleted-row');
            deleteBtn.classList.remove('hidden');
            redoBtn.classList.add('hidden');
            deletedRows.delete(index);
            
            // Re-enable the inputs
            ['expiry', 'opening', 'received', 'used', 'given', 'given_facility', 'closing'].forEach(field => {
                const input = document.getElementById(`${field}_${index}`);
                if (input) {
                    input.disabled = false;
                }
            });
        }

        function clearAllEntries() {
            if (confirm('Are you sure you want to clear all entries? This action cannot be undone.')) {
                commodities.forEach((commodity, index) => {
                    ['expiry', 'opening', 'received', 'used', 'given', 'given_facility'].forEach(field => {
                        const input = document.getElementById(`${field}_${index}`);
                        if (input) {
                            input.value = '';
                        }
                    });
                    document.getElementById(`closing_${index}`).value = '';
                    
                    // Restore deleted rows
                    if (deletedRows.has(index)) {
                        redoRow(index);
                    }
                });
            }
        }

        function cancelReport() {
            if (confirm('Are you sure you want to cancel this report? All unsaved data will be lost.')) {
                document.getElementById('commoditiesSection').classList.add('hidden');
                document.getElementById('backToReports').style.display = 'none';
                deletedRows.clear();
                
                // Reset all form fields
                document.querySelectorAll('#reportsTab input, #reportsTab select').forEach(input => {
                    if (input.type !== 'submit') input.value = '';
                });
            }
        }

        function calculateBalance(index) {
            const opening = parseInt(document.getElementById(`opening_${index}`).value) || 0;
            const received = parseInt(document.getElementById(`received_${index}`).value) || 0;
            const used = parseInt(document.getElementById(`used_${index}`).value) || 0;
            const given = parseInt(document.getElementById(`given_${index}`).value) || 0;
            
            const closing = opening + received - used - given;
            document.getElementById(`closing_${index}`).value = Math.max(0, closing);
        }

        function submitReport() {
            const province = document.getElementById('reportProvince').value;
            const hub = document.getElementById('reportHub').value;
            const district = document.getElementById('reportDistrict').value;
            const period = document.getElementById('reportPeriod').value;
            const year = document.getElementById('reportYear').value;
            const weekMonth = document.getElementById('reportWeekMonth').value;
            const reporterName = document.getElementById('reporterName').value;
            const facilityId = document.getElementById('reportFacility').value;

            if (!province || !hub || !district || !period || !year || !weekMonth || !reporterName || !facilityId) {
                alert('Please fill in all report details first');
                return;
            }

            const facility = facilities.find(f => f.id == facilityId);
            if (!facility) {
                alert('Invalid facility selected');
                return;
            }

            // Collect commodity data (excluding deleted rows)
            const commodityData = [];
            let hasErrors = false;
            
            commodities.forEach((commodity, index) => {
                if (deletedRows.has(index)) return; // Skip deleted rows
                
                const expiry = document.getElementById(`expiry_${index}`).value;
                const opening = document.getElementById(`opening_${index}`).value;
                const received = document.getElementById(`received_${index}`).value;
                const used = document.getElementById(`used_${index}`).value;
                const given = document.getElementById(`given_${index}`).value;
                const givenFacility = document.getElementById(`given_facility_${index}`).value;
                const closing = document.getElementById(`closing_${index}`).value;

                if (!expiry || !opening || !received || !used || !given) {
                    alert(`Please fill in all fields for ${commodity.name}`);
                    hasErrors = true;
                    return;
                }

                commodityData.push({
                    commodity_id: commodity.id,
                    commodity_name: commodity.name,
                    expiry_date: expiry,
                    opening_balance: parseInt(opening),
                    received: parseInt(received),
                    used: parseInt(used),
                    given_to_other: parseInt(given),
                    given_facility_name: givenFacility,
                    closing_balance: parseInt(closing)
                });
            });

            if (hasErrors) return;

            if (commodityData.length === 0) {
                alert('You must have at least one commodity entry to submit a report');
                return;
            }

            const newReport = {
                id: Date.now(),
                facility_id: facilityId,
                facility_name: facility.name,
                province_name: provinces.find(p => p.id == province)?.name,
                hub_name: hubs.find(h => h.id == hub)?.name,
                district_name: districts.find(d => d.id == district)?.name,
                reporter_name: reporterName,
                reporter_email: currentUser.email,
                period: period,
                week_month: weekMonth,
                year: year,
                commodities: commodityData,
                status: 'pending',
                date_submitted: new Date().toISOString(),
                reviewed_by: null,
                review_date: null
            };

            reports.push(newReport);
            localStorage.setItem('msms_reports', JSON.stringify(reports));

            alert('Report submitted successfully for review!');
            
            // Clear draft and reset form
            clearDraft();
            cancelReport();
            loadDashboard();
        }

        // Review Functions
        function loadReviewReports() {
            const tbody = document.getElementById('reviewBody');
            tbody.innerHTML = '';

            const reportsToShow = currentUser.role === 'coordinator' 
                ? reports 
                : reports.filter(r => r.reporter_email === currentUser.email);

            reportsToShow.forEach(report => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>RPT-${report.id}</td>
                    <td>${report.facility_name}</td>
                    <td>${report.reporter_name}</td>
                    <td>${report.period} ${report.week_month} ${report.year}</td>
                    <td>${new Date(report.date_submitted).toLocaleDateString()}</td>
                    <td><span class="status-badge status-${report.status}">${report.status.toUpperCase()}</span></td>
                    <td>
                        <button onclick="viewReport(${report.id})" class="btn btn-primary">View</button>
                        ${currentUser.role === 'coordinator' && report.status === 'pending' ? 
                            `<button onclick="reviewReport(${report.id})" class="btn btn-secondary">Review</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function viewReport(reportId) {
            const report = reports.find(r => r.id === reportId);
            if (!report) return;

            let detailsHtml = `
                <h3>Report: RPT-${report.id}</h3>
                <p><strong>Facility:</strong> ${report.facility_name}</p>
                <p><strong>Reporter:</strong> ${report.reporter_name}</p>
                <p><strong>Period:</strong> ${report.period} ${report.week_month} ${report.year}</p>
                <p><strong>Status:</strong> <span class="status-badge status-${report.status}">${report.status.toUpperCase()}</span></p>
                <p><strong>Submitted:</strong> ${new Date(report.date_submitted).toLocaleDateString()}</p>
                
                <h4>Commodities Report:</h4>
                <table class="table">
                    <thead>
                        <tr>
                            <th>Commodity</th>
                            <th>Expiry Date</th>
                            <th>Opening</th>
                            <th>Received</th>
                            <th>Used</th>
                            <th>Given</th>
                            <th>Given to Facility</th>
                            <th>Closing</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            report.commodities.forEach(comm => {
                detailsHtml += `
                    <tr>
                        <td>${comm.commodity_name}</td>
                        <td>${comm.expiry_date}</td>
                        <td>${comm.opening_balance}</td>
                        <td>${comm.received}</td>
                        <td>${comm.used}</td>
                        <td>${comm.given_to_other}</td>
                        <td>${comm.given_facility_name || 'N/A'}</td>
                        <td>${comm.closing_balance}</td>
                    </tr>
                `;
            });

            detailsHtml += '</tbody></table>';

            document.getElementById('reportDetails').innerHTML = detailsHtml;
            document.getElementById('reportModal').style.display = 'block';
            currentReport = report;
        }

        function reviewReport(reportId) {
            viewReport(reportId);
        }

        function approveReport() {
            if (!currentReport || currentUser.role !== 'coordinator') return;

            const reportIndex = reports.findIndex(r => r.id === currentReport.id);
            if (reportIndex !== -1) {
                reports[reportIndex].status = 'approved';
                reports[reportIndex].reviewed_by = currentUser.name;
                reports[reportIndex].review_date = new Date().toISOString();
                localStorage.setItem('msms_reports', JSON.stringify(reports));
                
                alert('Report approved successfully!');
                closeModal();
                loadReviewReports();
                loadDashboard();
            }
        }

        function rejectReport() {
            if (!currentReport || currentUser.role !== 'coordinator') return;

            const reason = prompt('Please provide a reason for rejection:');
            if (!reason) return;

            const reportIndex = reports.findIndex(r => r.id === currentReport.id);
            if (reportIndex !== -1) {
                reports[reportIndex].status = 'rejected';
                reports[reportIndex].reviewed_by = currentUser.name;
                reports[reportIndex].review_date = new Date().toISOString();
                reports[reportIndex].rejection_reason = reason;
                localStorage.setItem('msms_reports', JSON.stringify(reports));
                
                alert('Report rejected successfully!');
                closeModal();
                loadReviewReports();
                loadDashboard();
            }
        }

        function closeModal() {
            document.getElementById('reportModal').style.display = 'none';
            currentReport = null;
        }

        // Management Functions
        function loadUserManagement() {
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.name}</td>
                    <td>${user.username}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td><span class="status-badge status-${user.status}">${user.status.toUpperCase()}</span></td>
                    <td>
                        ${user.status === 'pending' ? 
                            `<button onclick="approveUser(${user.id})" class="btn btn-success">Approve</button>
                             <button onclick="rejectUser(${user.id})" class="btn btn-danger">Reject</button>` : ''}
                        ${user.id !== currentUser.id ? 
                            `<button onclick="deleteUser(${user.id})" class="btn btn-danger">Delete</button>` : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function approveUser(userId) {
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                users[userIndex].status = 'approved';
                localStorage.setItem('msms_users', JSON.stringify(users));
                loadUserManagement();
                alert('User approved successfully!');
            }
        }

        function rejectUser(userId) {
            const userIndex = users.findIndex(u => u.id === userId);
            if (userIndex !== -1) {
                users[userIndex].status = 'rejected';
                localStorage.setItem('msms_users', JSON.stringify(users));
                loadUserManagement();
                alert('User rejected successfully!');
            }
        }

        function deleteUser(userId) {
            if (confirm('Are you sure you want to delete this user?')) {
                users = users.filter(u => u.id !== userId);
                localStorage.setItem('msms_users', JSON.stringify(users));
                loadUserManagement();
                alert('User deleted successfully!');
            }
        }

        function addFacility() {
            const province = document.getElementById('newFacilityProvince').value;
            const hub = document.getElementById('newFacilityHub').value;
            const district = document.getElementById('newFacilityDistrict').value;
            const name = document.getElementById('newFacilityName').value;
            const type = document.getElementById('newFacilityType').value;

            if (!province || !hub || !district || !name || !type) {
                alert('Please fill in all facility details');
                return;
            }

            const newFacility = {
                id: Date.now(),
                name,
                province_id: parseInt(province),
                hub_id: parseInt(hub),
                district_id: parseInt(district),
                type
            };

            facilities.push(newFacility);
            localStorage.setItem('msms_facilities', JSON.stringify(facilities));
            
            // Clear form
            document.getElementById('newFacilityProvince').value = '';
            document.getElementById('newFacilityHub').innerHTML = '<option value="">Select Hub</option>';
            document.getElementById('newFacilityDistrict').innerHTML = '<option value="">Select District</option>';
            document.getElementById('newFacilityName').value = '';
            document.getElementById('newFacilityType').value = '';
            
            alert('Facility added successfully!');
        }

        function addCommodity() {
            const name = document.getElementById('newCommodityName').value;
            const category = document.getElementById('newCommodityCategory').value;
            const description = document.getElementById('newCommodityDescription').value;
            const unit = document.getElementById('newCommodityUnit').value;

            if (!name || !category || !description || !unit) {
                alert('Please fill in all commodity details');
                return;
            }

            const newCommodity = {
                id: Date.now(),
                name,
                category,
                description,
                unit
            };

            commodities.push(newCommodity);
            localStorage.setItem('msms_commodities', JSON.stringify(commodities));
            
            document.getElementById('newCommodityName').value = '';
            document.getElementById('newCommodityCategory').value = '';
            document.getElementById('newCommodityDescription').value = '';
            document.getElementById('newCommodityUnit').value = '';
            
            alert('Commodity added successfully!');
        }

        // Location management functions
        function addProvince() {
            const name = document.getElementById('newProvinceName').value;
            if (!name) {
                alert('Please enter province name');
                return;
            }

            const newProvince = {
                id: Date.now(),
                name
            };

            provinces.push(newProvince);
            localStorage.setItem('msms_provinces', JSON.stringify(provinces));
            
            document.getElementById('newProvinceName').value = '';
            populateDropdowns();
            loadProvincesList();
            alert('Province added successfully!');
        }

        function addHub() {
            const provinceId = document.getElementById('hubProvince').value;
            const name = document.getElementById('newHubName').value;
            
            if (!provinceId || !name) {
                alert('Please select province and enter hub name');
                return;
            }

            const newHub = {
                id: Date.now(),
                name,
                province_id: parseInt(provinceId)
            };

            hubs.push(newHub);
            localStorage.setItem('msms_hubs', JSON.stringify(hubs));
            
            document.getElementById('newHubName').value = '';
            loadHubsList();
            alert('Hub added successfully!');
        }

        function addDistrict() {
            const provinceId = document.getElementById('districtProvince').value;
            const hubId = document.getElementById('districtHub').value;
            const name = document.getElementById('newDistrictName').value;
            
            if (!provinceId || !hubId || !name) {
                alert('Please select province, hub and enter district name');
                return;
            }

            const newDistrict = {
                id: Date.now(),
                name,
                province_id: parseInt(provinceId),
                hub_id: parseInt(hubId)
            };

            districts.push(newDistrict);
            localStorage.setItem('msms_districts', JSON.stringify(districts));
            
            document.getElementById('newDistrictName').value = '';
            loadDistrictsList();
            alert('District added successfully!');
        }

        function loadProvincesList() {
            const container = document.getElementById('provincesList');
            container.innerHTML = '';
            provinces.forEach(province => {
                container.innerHTML += `<p>${province.name}</p>`;
            });
        }

        function loadHubsList() {
            const container = document.getElementById('hubsList');
            container.innerHTML = '';
            hubs.forEach(hub => {
                const province = provinces.find(p => p.id === hub.province_id);
                container.innerHTML += `<p>${hub.name} (${province?.name})</p>`;
            });
        }

        function loadDistrictsList() {
            const container = document.getElementById('districtsList');
            container.innerHTML = '';
            districts.forEach(district => {
                const province = provinces.find(p => p.id === district.province_id);
                const hub = hubs.find(h => h.id === district.hub_id);
                container.innerHTML += `<p>${district.name} - ${hub?.name}, ${province?.name}</p>`;
            });
        }Category').value;
            const description = document.getElementById('newCommodityDescription').value;

            if (!name || !category || !description) {
                alert('Please fill in all commodity details');
                return;
            }

            const newCommodity = {
                id: Date.now(),
                name,
                category,
                description
            };

            commodities.push(newCommodity);
            localStorage.setItem('msms_commodities', JSON.stringify(commodities));
            
            document.getElementById('newCommodityName').value = '';
            document.getElementById('newCommodityCategory').value = '';
            document.getElementById('newCommodityDescription').value = '';
            
            alert('Commodity added successfully!');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeDefaultData();
            
            // Load saved data from localStorage on page refresh
            users = JSON.parse(localStorage.getItem('msms_users') || '[]');
            facilities = JSON.parse(localStorage.getItem('msms_facilities') || '[]');
            commodities = JSON.parse(localStorage.getItem('msms_commodities') || '[]');
            reports = JSON.parse(localStorage.getItem('msms_reports') || '[]');
            provinces = JSON.parse(localStorage.getItem('msms_provinces') || '[]');
            hubs = JSON.parse(localStorage.getItem('msms_hubs') || '[]');
            districts = JSON.parse(localStorage.getItem('msms_districts') || '[]');
            reportDraft = JSON.parse(localStorage.getItem('msms_draft') || 'null');
            
            // Initialize default data if needed
            initializeDefaultData();
            
            // Load management lists if on manage tab
            if (document.getElementById('manageTab').classList.contains('active')) {
                loadProvincesList();
                loadHubsList();
                loadDistrictsList();
            }
            
            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('reportModal');
                if (event.target === modal) {
                    closeModal();
                }
            };
            
            // Auto-save form data to prevent data loss
            setInterval(() => {
                if (currentUser && !document.getElementById('commoditiesSection').classList.contains('hidden')) {
                    try {
                        const hasData = commodities.some((commodity, index) => {
                            if (deletedRows.has(index)) return false;
                            const fields = ['expiry', 'opening', 'received', 'used', 'given'];
                            return fields.some(field => {
                                const input = document.getElementById(`${field}_${index}`);
                                return input && input.value;
                            });
                        });
                        if (hasData) {
                            saveDraft();
                        }
                    } catch (error) {
                        console.log('Auto-save failed:', error);
                    }
                }
            }, 300000); // Auto-save every 5 minutes
        });

        // Data persistence functions
        function saveAllData() {
            localStorage.setItem('msms_users', JSON.stringify(users));
            localStorage.setItem('msms_facilities', JSON.stringify(facilities));
            localStorage.setItem('msms_commodities', JSON.stringify(commodities));
            localStorage.setItem('msms_reports', JSON.stringify(reports));
            localStorage.setItem('msms_provinces', JSON.stringify(provinces));
            localStorage.setItem('msms_hubs', JSON.stringify(hubs));
            localStorage.setItem('msms_districts', JSON.stringify(districts));
        }

        // Prevent data loss on page refresh
        window.addEventListener('beforeunload', function(e) {
            if (currentUser && !document.getElementById('commoditiesSection').classList.contains('hidden')) {
                // Check if there's unsaved data in the form
                let hasUnsavedData = false;
                commodities.forEach((commodity, index) => {
                    if (!deletedRows.has(index)) {
                        const fields = ['expiry', 'opening', 'received', 'used', 'given'];
                        for (let field of fields) {
                            const input = document.getElementById(`${field}_${index}`);
                            if (input && input.value) {
                                hasUnsavedData = true;
                                break;
                            }
                        }
                    }
                });
                
                if (hasUnsavedData) {
                    const confirmationMessage = 'You have unsaved changes. Are you sure you want to leave?';
                    e.returnValue = confirmationMessage;
                    return confirmationMessage;
                }
            }
        });

        // Enhanced management tab functionality
        function loadManagementTab() {
            populateDropdowns();
            loadProvincesList();
            loadHubsList();
            loadDistrictsList();
        }
    </script>
</body>
</html>